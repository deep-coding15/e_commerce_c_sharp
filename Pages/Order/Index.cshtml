@page
@model E_commerce_c_charp.Pages_Order.IndexModel
@{
    ViewData["Title"] = "Mes commandes";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="bi bi-box-seam"></i> Mes commandes
    </h1>
    <span class="text-muted">@Model.Dashboard.OrdersCount commandes</span>
</div>

@if (!Model.Dashboard.Orders.Any())
{
    <div class="empty-state text-center py-5">
        <i class="bi bi-inbox display-4 text-muted"></i>
        <h3 class="mt-3">Aucune commande</h3>
        <p>Vous n'avez pas encore passé de commande.</p>
        <a asp-page="/Product/Index" class="btn btn-primary mt-3">
            <i class="bi bi-shop"></i> Découvrir nos produits
        </a>
    </div>
}
else
{
    <!-- Tuiles de statistiques globales -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="small text-muted">Total dépensé</div>
                    <div class="h4 text-primary">@Model.Dashboard.TotalSpent.ToString("0.00") €</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="small text-muted">En cours</div>
                    <div class="h4">@Model.Dashboard.InProgress</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="small text-muted">Livrées</div>
                    <div class="h4 text-success">@Model.Dashboard.Delivered</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="small text-muted">Articles achetés</div>
                    <div class="h4">@Model.Dashboard.ItemsPurchased</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des commandes -->
    @foreach (var order in Model.Dashboard.Orders)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <div class="small text-muted">
                            @* <i class="bi bi-hash"> </i>*@
                            • @order.OrderNumber <br/>
                            • @order.ItemsCount articles
                        </div>
                        <div class="small text-muted">
                            <i class="bi bi-calendar"></i>
                            Passée le @order.CreatedAt.ToString("dd MMMM yyyy 'à' HH:mm")
                        </div>
                    </div>
                    <span class="badge @order.StatusCssClass px-3 py-2">
                        @order.StatusLabel
                    </span>
                </div>

                <h6 class="fw-bold mb-2">Articles commandés</h6>

                @foreach (var item in order.Items)
                {
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="@item.ImageUrl"
                                 alt="@item.ProductName"
                                 class="rounded"
                                 style="width:60px;height:60px;object-fit:cover;" />
                            <div>
                                <div>@item.ProductName</div>
                                @if (!string.IsNullOrWhiteSpace(item.Variant))
                                {
                                    <div class="text-muted small">@item.Variant</div>
                                }
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">× @item.Quantity</div>
                            <div>@item.UnitPrice.ToString("0.00") €</div>
                        </div>
                    </div>
                }

                <hr />

                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                    <div class="mb-3 mb-md-0">
                        <div class="small text-muted mb-1">Adresse de livraison</div>
                        <div>@order.DeliveryAddress</div>
                        <div class="small text-muted">
                            <i class="bi bi-truck"></i>
                            Livraison estimée : @order.EstimatedDelivery.ToString("dd MMMM yyyy")
                        </div>
                    </div>
                    <div class="text-md-end">
                        <div class="small text-muted">Montant total</div>
                        <div class="h5 text-primary mb-3">@order.Total.ToString("0.00") €</div>

                        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                            @if(@order.StatusLabel == "commandee") {
                                <button class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> Annuler
                                </button>
                            }
                            <div>@order.StatusLabel</div>
                            @* <a asp-page="./Details" asp-route-id="@order.OrderNumber" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> Détails
                            </a>
                            <button class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Renouveler
                            </button> *@
                            
                        </div>
                    </div>
                </div>

                <!-- Timeline simplifiée des statuts -->
                @* <div class="mt-3 small text-muted">
                    <span class="me-2">
                        <i class="bi bi-dot text-primary"></i> Commandée
                    </span>
                    <span class="me-2">
                        <i class="bi bi-dot @(order.StatusLabel is "Completed" or "Delivered" ? "text-primary" : "")"></i> Confirmée
                    </span>
                    <span class="me-2">
                        <i class="bi bi-dot @(order.StatusLabel is "Completed" or "Delivered" ? "text-primary" : "")"></i> En préparation
                    </span>
                    <span class="me-2">
                        <i class="bi bi-dot @(order.StatusLabel is "Delivered" ? "text-primary" : "")"></i> Expédiée
                    </span>
                    <span>
                        <i class="bi bi-dot @(order.StatusLabel is "Delivered" ? "text-primary" : "")"></i> Livrée
                    </span>
                </div> *@
            </div>
        </div>
    }
}
